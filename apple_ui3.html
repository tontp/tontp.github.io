<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="apple_ui.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body class="dark-mode">
  <header>
    <nav class="navbar">
      <a href="#" class="active">Dashboard</a>
      <a href="#">Reports</a>
      <a href="#" id="settings-button">Settings</a>
      <div class="theme-switch-wrapper">
        <i class="fas fa-sun"></i>
        <label class="theme-switch" for="theme-toggle">
          <input type="checkbox" id="theme-toggle" />
          <div class="slider round"></div>
        </label>
        <i class="fas fa-moon"></i>
      </div>
      <a href="index.html" class="logout">Logout</a>
    </nav>
  </header>

  <main class="main-container">
    <div class="ag-format-container">
      <div class="ag-courses_box">
        <div class="ag-courses_item" id="weather-card">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title">
            <i class="fas fa-cloud-sun"></i> ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          </div>
          <div class="ag-courses-item_date-box">‡πÄ‡∏°‡∏∑‡∏≠‡∏á: <span id="city">Loading...</span></div>
          <div class="ag-courses-item_date-box">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: <span id="temperature">... ¬∞C</span></div>
          <div class="ag-courses-item_date-box">‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: <span id="weather-description">...</span></div>
        </div>

        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-cloud-rain"></i> ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å</div>
          <div class="ag-courses-item_date-box"><span id="rain-probability">... %</span></div>
        </div>

        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-leaf"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô</div>
          <div class="ag-courses-item_date-box"><span id="soil-moisture">... %</span></div>
        </div>

        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-tint"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div>
          <div class="ag-courses-item_date-box"><span id="air-humidity">... %</span></div>
        </div>

        <div class="ag-courses_item" id="status-card">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-power-off"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
          <div class="status-container">
            <div id="status-dot"></div>
            <span id="status-text">Checking...</span>
            </div>
        </div>
      </div>
      
      <div class="ag-courses_item pump-status-card">
        <div class="ag-courses-item_bg"></div>
        <div class="ag-courses-item_title">
          <i class="fas fa-water"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°
        </div>
        <div class="status-container">
          <div id="pump-dot"></div>
          <span id="pump-text">Loading...</span>
        </div>
      </div>


<script>
  // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏±‡πä‡∏° (‡πÉ‡∏ä‡πâ JSONBin)
  const BIN_ID = "68fe94c7ae596e708f2ebc87";
  const ACCESS_KEY = "$2a$10$rKnMDmrJtgjKVrtT1vksSOism/gMhZXC1lKlaadWVCaO2EES5mkGG"; 
  let pumpState = 0;

  async function updatePumpState(state) {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": ACCESS_KEY,
          "X-Bin-Versioning": "false"
        },
        body: JSON.stringify({ record: { record: { pump: state } } })
      });

      if (!res.ok) throw new Error("Failed to update");

      pumpState = state;
      const btn = document.getElementById("pump-btn");
      btn.textContent = state ? "üõë ‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°" : "üö∞ ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏±‡πä‡∏°";
      btn.style.backgroundColor = state ? "#ff3b30" : "#007aff";

    } catch (err) {
      console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏î‡πâ:", err);
    }
  }

  document.getElementById("pump-btn").addEventListener("click", () => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Online ‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏±‡πä‡∏°
    if (!window.isOnline) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏î‡πâ: ‡∏£‡∏∞‡∏ö‡∏ö Offline");
        return;
    }
    updatePumpState(pumpState ? 0 : 1);
  });
</script>


      <div class="ag-courses_box graph-container">
        <div class="graph-card">
          <h2 class="graph-title"><i class="fas fa-water"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å</h2>
          <canvas id="waterLevelChart"></canvas>
        </div>
        <div class="graph-card">
          <h2 class="graph-title"><i class="fas fa-tint"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô</h2>
          <canvas id="moistureChart"></canvas>
        </div>
        <div class="graph-card map-card">
          <h2 class="graph-title"><i class="fas fa-map-marker-alt"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</h2>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>¬© 2025 ‡∏£‡∏±‡∏Å‡∏ô‡πâ‡∏≥‡∏£‡∏±‡∏Å‡∏õ‡∏•‡∏≤‡∏£‡∏±‡∏Å‡∏ã‡∏≤‡∏Å‡∏∏‡∏£‡∏∞ Inc. All rights reserved.</p>
  </footer>

<script>
const WEATHER_API_KEY = '4dbc27312596168489e3c0398366f2d5';
const city = 'Tha Muang'; 
const SHEET_API = "https://script.google.com/macros/s/AKfycbw5EzzEbt38WhpWfS1qa02Xr83ynFnBKyBX5PAp-9MUbHdbcAwA36KcGceuQvi2nFJqDw/exec?api=latest";
let lastUpdateTime = 0;
window.isOnline = false; // üìå ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global (window.isOnline)

// üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å OpenWeather
async function fetchWeatherData() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${WEATHER_API_KEY}&units=metric&lang=th`);
    if (!res.ok) throw new Error("Failed to fetch weather data");
    return await res.json();
  } catch (err) {
    console.warn("Weather API error, using mock data", err);
    return {
      name: 'Bangkok (Mock)',
      main: { temp: 32.5, humidity: 75 },
      weather: [{ description: 'Clear sky' }],
      coord: { lat: 13.75, lon: 100.5 }
    };
  }
}


// üü¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô card (Online/Offline) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏¢‡πâ‡∏≤‡∏¢ Time Box ‡πÄ‡∏Ç‡πâ‡∏≤ Card
async function updateTime() {
  try {
    const res = await fetch(SHEET_API, { cache: "no-cache" }); 
    const data = await res.json();

    let apiTimeStr = null;
    if (data.rows && data.rows.length) {
      apiTimeStr = data.rows[0]["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"];
    } else if (Array.isArray(data) && data.length) {
      apiTimeStr = data[0]["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"];
    }

    const dot = document.getElementById('status-dot');
    const text = document.getElementById('status-text');
    const statusCard = document.getElementById('status-card'); 

    if (!apiTimeStr) {
      text.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤";
      dot.style.backgroundColor = "gray";
      window.isOnline = false; // üìå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Global
      return;
    }

    const apiTime = new Date(apiTimeStr);
    const now = new Date();
    const diffMin = ((now - apiTime) / 60000).toFixed(2);

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Online/Offline
    if (diffMin < 2) {
      dot.style.backgroundColor = '#28a745';
      text.textContent = 'Online';
      text.style.color = '#28a745';
      window.isOnline = true; // üìå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Global
    } else {
      dot.style.backgroundColor = '#dc3545';
      text.textContent = 'Offline';
      text.style.color = '#dc3545';
      window.isOnline = false; // üìå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Global
    }
    
    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Time Box ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Card
    let timeBox = document.getElementById("time-box");
    if (!timeBox) {
      timeBox = document.createElement("div");
      timeBox.id = "time-box";
      timeBox.classList.add("ag-courses-item_date-box"); 
      timeBox.style.marginTop = "10px";
      if (statusCard) {
        statusCard.appendChild(timeBox); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Card ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      }
    }
    
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
    const options = { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
    
    timeBox.innerHTML = `
      <p style="margin: 0; padding: 0; line-height: 1.5; font-size: 0.8em; color: #aaa;">‚è∞ API: ${apiTime.toLocaleDateString('th-TH', options)}</p>
      <p style="margin: 0; padding: 0; line-height: 1.5; font-size: 0.8em; color: #aaa;">üïí ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${now.toLocaleDateString('th-TH', options)}</p>
      <p style="margin: 0; padding: 0; line-height: 1.5; font-size: 0.8em; color: #aaa;">‚è±Ô∏è ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô: ${diffMin} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
    `;

  } catch (err) {
    console.error("‚ùå Error fetching API time:", err);
    const text = document.getElementById('status-text');
    const dot = document.getElementById('status-dot');
    text.textContent = "‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API";
    dot.style.backgroundColor = "gray";
    window.isOnline = false; // üìå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Global
  }
}

// ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥
updateTime();
setInterval(updateTime, 5000);


// =========================================================================
// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
// =========================================================================

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Chart Instances
window.moistureChart = null;
window.waterChart = null;

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
function createMoistureChart(rows) {
  // rows ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà)
  const labels = rows.map(r => new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"]).toLocaleTimeString('th-TH', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }));
  const soilData = rows.map(r => Number(r["% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô"] || 0));

  const moistCanvas = document.getElementById('moistureChart');
  if (moistCanvas) {
    // üõ°Ô∏è ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
    if (window.moistureChart) {
        window.moistureChart.destroy();
        console.log("üìâ Old Moisture Chart destroyed."); 
    }
    
    const moistCtx = moistCanvas.getContext('2d');
    window.moistureChart = new Chart(moistCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô (%)',
          data: soilData,
          borderColor: 'rgba(148,216,45,1)',
          backgroundColor: 'rgba(148,216,45,0.2)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#fff' } },
          y: { 
              beginAtZero: true, 
              max: 100, 
              ticks: { color: '#fff' } 
          }
        }
      }
    });
  } else {
    console.error("Moisture Chart Canvas Element not found.");
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
function createWaterChart(rows) {
  // rows ‡∏ñ‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà)
  const labels = rows.map(r => new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"]).toLocaleTimeString('th-TH', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
  }));
  const rainData = rows.map(r => Number(r["‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å (%)"] || 0));

  const waterCanvas = document.getElementById('waterLevelChart');
  if (waterCanvas) {
    // üõ°Ô∏è ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
    if (window.waterChart) {
        window.waterChart.destroy();
        console.log("üìâ Old Water Chart destroyed."); 
    }
    
    const waterCtx = waterCanvas.getContext('2d');
    window.waterChart = new Chart(waterCtx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å (%)',
          data: rainData,
          borderColor: 'rgba(54,162,235,1)',
          backgroundColor: 'rgba(54,162,235,0.2)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#fff' } },
          y: { 
              beginAtZero: true, 
              max: 100, 
              ticks: { color: '#fff' } 
          }
        }
      }
    });
  } else {
    console.error("Water Chart Canvas Element not found.");
  }
}

// üìà ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å (main update function)
async function updateCharts() {
  try {
    // ‚úÖ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cache Busting
    const apiUrl = `https://script.google.com/macros/s/AKfycbw5EzzEbt38WhpWfS1qa02Xr83ynFnBKyBX5PAp-9MUbHdbcAwA36KcGceuQvi2nFJqDw/exec?api=latest&limit=20&_=${Date.now()}`;
    console.log("‚û°Ô∏è Fetching new data for charts:", apiUrl);

    const res = await fetch(apiUrl, { cache: "no-cache" });
    
    const text = await res.text();
    // üîß ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô JSON invalid
    const fixedText = text.replace(/,(\s*])/, "$1");
    const data = JSON.parse(fixedText);

    const rows = data.rows || [];
    if (!rows.length) {
      console.warn("No rows found in Sheet data");
      return;
    }

    // üîÑ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà (‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡πÉ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü)
    const reversedRows = [...rows].reverse();

    const latestTime = new Date(rows[0]["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"]).toLocaleTimeString('th-TH');
    console.log("‚úÖ Data successfully fetched. Latest data time:", latestTime);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Card 
    const latestData = rows[0];
    const soilMoisture = Number(latestData["% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô"] || 0);
    const rainProbability = Number(latestData["‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å (%)"] || 0);
    
    // üîÄ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Card ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    document.getElementById('rain-probability').textContent = rainProbability + ' %'; 
    document.getElementById('soil-moisture').textContent = soilMoisture + ' %'; 

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Array ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    createMoistureChart(reversedRows); 
    createWaterChart(reversedRows);    
    
    console.log("üìà Charts update functions called with reversed data.");

  } catch (err) {
    console.error("‚ùå Error loading or updating charts:", err);
  }
}

// üîπ ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°‡∏ï‡∏≤‡∏° API ‡πÉ‡∏´‡∏°‡πà
async function fetchPumpStatus() {
  const dot = document.getElementById("pump-dot");
  const textEl = document.getElementById("pump-text");
  const pumpBtn = document.getElementById("pump-btn");
  
  // üìå ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å: ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Offline ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏¢‡∏∏‡∏î"
  if (!window.isOnline) {
    dot.style.backgroundColor = "#dc3545"; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
    textEl.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚ùå (Offline)";
    pumpBtn.disabled = true; // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏õ‡∏±‡πä‡∏°
    pumpBtn.style.opacity = 0.5;
    return;
  }
  
  // üìå ‡∏ñ‡πâ‡∏≤ Online ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° API ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
  pumpBtn.disabled = false;
  pumpBtn.style.opacity = 1;

  try {
    const res = await fetch(
      `https://script.google.com/macros/s/AKfycbw5EzzEbt38WhpWfS1qa02Xr83ynFnBKyBX5PAp-9MUbHdbcAwA36KcGceuQvi2nFJqDw/exec?api=latest&_=${Date.now()}`
    );
    const text = await res.text();

    const fixedText = text.replace(/,(\s*])/, "$1");
    const data = JSON.parse(fixedText);

    const rows = data.rows || [];
    if (!rows.length) throw new Error("No data");

    const latest = rows[0]; 
    const pumpStatus = latest["‡∏õ‡∏±‡πä‡∏°"] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";

    if (["‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "1", "on"].includes(pumpStatus)) {
      dot.style.backgroundColor = "#28a745";
      textEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô üíß";
    } else if (["‡∏´‡∏¢‡∏∏‡∏î", "0", "off"].includes(pumpStatus)) {
      dot.style.backgroundColor = "#ff3b30";
      textEl.textContent = "‡∏´‡∏¢‡∏∏‡∏î üõë";
    } else {
      dot.style.backgroundColor = "gray";
      textEl.textContent = `‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å (${pumpStatus})`;
    }
  } catch (err) {
    console.error("Cannot fetch pump status:", err);
    dot.style.backgroundColor = "gray";
    textEl.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏î‡πâ";
  }
}

// =========================================================================
// ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à 
// =========================================================================
document.addEventListener('DOMContentLoaded', async () => {
  const weather = await fetchWeatherData();
  document.getElementById('city').textContent = weather.name;
  document.getElementById('temperature').textContent = weather.main.temp + ' ¬∞C';
  document.getElementById('weather-description').textContent = weather.weather[0].description;
  document.getElementById('air-humidity').textContent = weather.main.humidity + ' %';

  // üåç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  const map = L.map('map', {
    center: [weather.coord.lat, weather.coord.lon],
    zoom: 10,
    layers: [L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')]
  });
  L.marker([weather.coord.lat, weather.coord.lon]).addTo(map).bindPopup(weather.name);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  updateCharts();
  setInterval(updateCharts, 10000); 

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°
  fetchPumpStatus();
  setInterval(fetchPumpStatus, 5000);


  // üß© Layout Drag Mode
  const settingsButton = document.getElementById('settings-button');
  const containers = document.querySelectorAll('.ag-courses_box');
  const sortables = Array.from(containers).map(c => new Sortable(c, { animation:150, ghostClass:'sortable-ghost', disabled:true }));
  let editMode = false;
  settingsButton.addEventListener('click', e => {
    e.preventDefault();
    editMode = !editMode;
    document.body.classList.toggle('edit-mode', editMode);
    settingsButton.textContent = editMode ? 'Save' : 'Settings';
    sortables.forEach(s => s.option('disabled', !editMode));
  });

  // üåó Theme Switch
  const themeToggle = document.getElementById('theme-toggle');
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    document.body.classList.add(savedTheme);
    themeToggle.checked = savedTheme === 'light-mode';
  }
  themeToggle.addEventListener('change', function() {
    if (this.checked) {
      document.body.classList.replace('dark-mode','light-mode');
      localStorage.setItem('theme','light-mode');
    } else {
      document.body.classList.replace('light-mode','dark-mode');
      localStorage.setItem('theme','dark-mode');
    }
  });

});
</script>

<style>
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î Time Box ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
  #status-card .ag-courses-item_date-box {
    margin-top: 5px; 
    padding: 0 10px; 
    font-size: 0.9em;
  }
  #status-card p {
    line-height: 1.4;
    margin: 0;
    padding: 0;
    color: #ccc;
  }
  /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏õ‡∏±‡πä‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô */
  .pump-status-card button:disabled {
    cursor: not-allowed;
  }
</style>
</body>
</html>
