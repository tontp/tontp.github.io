<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="apple_ui.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body class="dark-mode">
  <header>
    <nav class="navbar">
      <a href="#" class="active">Dashboard</a>
      <a href="#">Reports</a>
      <a href="#" id="settings-button">Settings</a>
      <div class="theme-switch-wrapper">
        <i class="fas fa-sun"></i>
        <label class="theme-switch" for="theme-toggle">
          <input type="checkbox" id="theme-toggle" />
          <div class="slider round"></div>
        </label>
        <i class="fas fa-moon"></i>
      </div>
      <a href="index.html" class="logout">Logout</a>
    </nav>
  </header>

  <main class="main-container">
    <div class="ag-format-container">
      <div class="ag-courses_box">
        <!-- WEATHER CARD -->
        <div class="ag-courses_item" id="weather-card">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title">
            <i class="fas fa-cloud-sun"></i> ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
          </div>
          <div class="ag-courses-item_date-box">‡πÄ‡∏°‡∏∑‡∏≠‡∏á: <span id="city">Loading...</span></div>
          <div class="ag-courses-item_date-box">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: <span id="temperature">... ¬∞C</span></div>
          <div class="ag-courses-item_date-box">‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®: <span id="weather-description">...</span></div>
        </div>

        <!-- WATER -->
        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-cloud-rain"></i> ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å</div>
          <div class="ag-courses-item_date-box"><span id="rain-probability">... %</span></div>
        </div>

        <!-- SOIL -->
        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-leaf"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô</div>
          <div class="ag-courses-item_date-box"><span id="soil-moisture">... %</span></div>
        </div>

        <!-- AIR HUMIDITY -->
        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-tint"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div>
          <div class="ag-courses-item_date-box"><span id="air-humidity">... %</span></div>
        </div>

        <!-- STATUS -->
        <div class="ag-courses_item">
          <div class="ag-courses-item_bg"></div>
          <div class="ag-courses-item_title"><i class="fas fa-power-off"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
          <div class="status-container">
            <div id="status-dot"></div>
            <span id="status-text">Checking...</span>
          </div>
        </div>
      </div>
<div class="ag-courses_item pump-status-card">
  <div class="ag-courses-item_bg"></div>
  <div class="ag-courses-item_title">
    <i class="fas fa-water"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°
  </div>
  <div class="status-container">
    <div id="pump-dot"></div>
    <span id="pump-text">Loading...</span>
  </div>
</div>
      <div class="ag-courses_box graph-container">
        <div class="graph-card">
          <h2 class="graph-title"><i class="fas fa-water"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≥</h2>
          <canvas id="waterLevelChart"></canvas>
        </div>
        <div class="graph-card">
          <h2 class="graph-title"><i class="fas fa-tint"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏®)</h2>
          <canvas id="moistureChart"></canvas>
        </div>
        <div class="graph-card map-card">
          <h2 class="graph-title"><i class="fas fa-map-marker-alt"></i> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</h2>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>¬© 2025 Apple Inc. All rights reserved.</p>
  </footer>

<script>
const WEATHER_API_KEY = '4dbc27312596168489e3c0398366f2d5';
const city = 'Tha Muang';
let lastUpdateTime = null; // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

// üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å OpenWeather
async function fetchWeatherData() {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${WEATHER_API_KEY}&units=metric&lang=th`);
    if (!res.ok) throw new Error("Failed to fetch weather data");
    return await res.json();
  } catch (err) {
    console.warn("Weather API error, using mock data");
    return {
      name: 'Bangkok (Mock)',
      main: { temp: 32.5, humidity: 75 },
      weather: [{ description: 'Clear sky' }],
      coord: { lat: 13.75, lon: 100.5 }
    };
  }
}

// üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å Google Apps Script
async function fetchSensorData() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbw5EzzEbt38WhpWfS1qa02Xr83ynFnBKyBX5PAp-9MUbHdbcAwA36KcGceuQvi2nFJqDw/exec?api=latest", { cache: "no-cache" });
    if (!res.ok) throw new Error("Failed to fetch sensor data");

    const data = await res.json();
    const rows = data.rows || [];
    return rows.length ? rows[rows.length - 1] : null; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  } catch (err) {
    console.error("Error fetching sensor data:", err);
    return null;
  }
}

// üü¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô card
function setStatus(online) {
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  if (online) {
    dot.style.backgroundColor = '#28a745';
    text.textContent = 'Online';
    text.style.color = '#28a745';
  } else {
    dot.style.backgroundColor = '#dc3545';
    text.textContent = 'Offline';
    text.style.color = '#dc3545';
  }
}

// ‚è±Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÑ‡∏´‡∏°
function checkOfflineTimeout() {
  if (!lastUpdateTime) return;
  const diff = (Date.now() - lastUpdateTime) / 1000;
  if (diff > 120) setStatus(false);
}

// üì° ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å API
async function updateSensors() {
  const data = await fetchSensorData();
  if (data) {
    lastUpdateTime = Date.now();
    setStatus(true);

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô card ‡∏ï‡∏≤‡∏° key ‡πÉ‡∏´‡∏°‡πà
    const soilMoisture = Number(data["% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô"] || 0);
    const rainProbability = Number(data["‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å (%)"] || 0);

    document.getElementById('rain-probability').textContent = rainProbability + ' %';
    document.getElementById('soil-moisture').textContent = soilMoisture + ' %';
  }
}

// üìä ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® + ‡∏Å‡∏£‡∏≤‡∏ü
document.addEventListener('DOMContentLoaded', async () => {
  const weather = await fetchWeatherData();
  document.getElementById('city').textContent = weather.name;
  document.getElementById('temperature').textContent = weather.main.temp + ' ¬∞C';
  document.getElementById('weather-description').textContent = weather.weather[0].description;
  document.getElementById('air-humidity').textContent = weather.main.humidity + ' %';

  // üåç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  const map = L.map('map', {
    center: [weather.coord.lat, weather.coord.lon],
    zoom: 10,
    layers: [L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')]
  });
  L.marker([weather.coord.lat, weather.coord.lon]).addTo(map).bindPopup(weather.name);

  // üìà ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å API ‡πÉ‡∏´‡∏°‡πà
  async function updateCharts() {
    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbw5EzzEbt38WhpWfS1qa02Xr83ynFnBKyBX5PAp-9MUbHdbcAwA36KcGceuQvi2nFJqDw/exec?api=latest&limit=20", { cache: "no-cache" });
      const data = await res.json();
      const rows = data.rows || [];
      if (!rows.length) return;

      const labels = rows.map(r => new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤"]).toLocaleTimeString('th-TH', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      }));
      const soilData = rows.map(r => Number(r["% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô"] || 0));
      const rainData = rows.map(r => Number(r["‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å (%)"] || 0));

      // üåßÔ∏è ‡∏Å‡∏£‡∏≤‡∏ü‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å
      const waterCtx = document.getElementById('waterLevelChart').getContext('2d');
      new Chart(waterCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ù‡∏ô‡∏ï‡∏Å (%)',
            data: rainData,
            borderColor: 'rgba(54,162,235,1)',
            backgroundColor: 'rgba(54,162,235,0.2)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: {
            x: { ticks: { color: '#fff' } },
            y: { beginAtZero: true, ticks: { color: '#fff' } }
          }
        }
      });

      // üå± ‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô
      const moistCtx = document.getElementById('moistureChart').getContext('2d');
      new Chart(moistCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô (%)',
            data: soilData,
            borderColor: 'rgba(148,216,45,1)',
            backgroundColor: 'rgba(148,216,45,0.2)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: {
            x: { ticks: { color: '#fff' } },
            y: { beginAtZero: true, ticks: { color: '#fff' } }
          }
        }
      });
    } catch (err) {
      console.error("Error loading charts:", err);
    }
  }

  updateCharts();
  setInterval(updateCharts, 10000);

  // üß© Layout Drag Mode
  const settingsButton = document.getElementById('settings-button');
  const containers = document.querySelectorAll('.ag-courses_box');
  const sortables = Array.from(containers).map(c => new Sortable(c, { animation:150, ghostClass:'sortable-ghost', disabled:true }));
  let editMode = false;
  settingsButton.addEventListener('click', e => {
    e.preventDefault();
    editMode = !editMode;
    document.body.classList.toggle('edit-mode', editMode);
    settingsButton.textContent = editMode ? 'Save' : 'Settings';
    sortables.forEach(s => s.option('disabled', !editMode));
  });

  // üåó Theme Switch
  const themeToggle = document.getElementById('theme-toggle');
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme) {
    document.body.classList.add(savedTheme);
    themeToggle.checked = savedTheme === 'light-mode';
  }
  themeToggle.addEventListener('change', function() {
    if (this.checked) {
      document.body.classList.replace('dark-mode','light-mode');
      localStorage.setItem('theme','light-mode');
    } else {
      document.body.classList.replace('light-mode','dark-mode');
      localStorage.setItem('theme','dark-mode');
    }
  });

  updateSensors();
  setInterval(updateSensors, 5000);
  setInterval(checkOfflineTimeout, 10000);
});

// üîπ ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡πä‡∏°‡∏ï‡∏≤‡∏° API ‡πÉ‡∏´‡∏°‡πà
async function fetchPumpStatus() {
  try {
    const res = await fetch(
      `https://script.google.com/macros/s/AKfycbw5EzzEbt38WhpWfS1qa02Xr83ynFnBKyBX5PAp-9MUbHdbcAwA36KcGceuQvi2nFJqDw/exec?api=latest&_=${Date.now()}`
    );
    const text = await res.text();

    // üîß ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô JSON invalid (‡∏•‡∏ö comma ‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ array)
    const fixedText = text.replace(/,(\s*])/, "$1");
    const data = JSON.parse(fixedText);

    const rows = data.rows || [];
    if (!rows.length) throw new Error("No data");

    const latest = rows[rows.length - 1];
    console.log("Latest Row:", latest); // ‚úÖ debug
    const pumpStatus = latest["‡∏õ‡∏±‡πä‡∏°"] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";

    const dot = document.getElementById("pump-dot");
    const textEl = document.getElementById("pump-text");

    if (["‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "1", "on"].includes(pumpStatus)) {
      dot.style.backgroundColor = "#28a745";
      textEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô üíß";
    } else if (["‡∏´‡∏¢‡∏∏‡∏î", "0", "off"].includes(pumpStatus)) {
      dot.style.backgroundColor = "#ff3b30";
      textEl.textContent = "‡∏´‡∏¢‡∏∏‡∏î üõë";
    } else {
      dot.style.backgroundColor = "gray";
      textEl.textContent = `‚ö†Ô∏è ‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å (${pumpStatus})`;
    }
  } catch (err) {
    console.error("Cannot fetch pump status:", err);
    const dot = document.getElementById("pump-dot");
    const textEl = document.getElementById("pump-text");
    dot.style.backgroundColor = "gray";
    textEl.textContent = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡πä‡∏°‡πÑ‡∏î‡πâ";
  }
}



fetchPumpStatus();
setInterval(fetchPumpStatus, 5000);
</script>


</body>
</html>
